<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Barcode Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
      /* Base Styles */
      

      /* Scan Button */
      #scan-btn {
        padding: 15px 30px;
        font-size: 18px;
        background: #2196f3;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      #scan-btn:hover {
        background: #1976d2;
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
      }

      /* Scanner Container */
      #scanner-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        width: 100%;
        max-width: 600px;
        aspect-ratio: 1.5;
        background: black;
        border-radius: 10px;
        overflow: hidden;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 1000;
      }

      #scanner-container.active {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }

      /* Video Element */
      #barcode-scanner {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Scan Overlay */
      #scan-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      /* Scan Line Animation */
      #scan-line {
        position: absolute;
        height: 3px;
        width: 100%;
        background: #00ff00;
        box-shadow: 0 0 10px #00ff00;
        animation: scan 2.5s infinite ease-in-out;
      }

      @keyframes scan {
        0%,
        100% {
          top: 5%;
        }
        50% {
          top: 95%;
        }
      }

      /* Scanned Data Display */
      #scanned-data {
        margin-top: 30px;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        max-width: 600px;
        width: 80%;
      }

      #scanned-data.show {
        opacity: 1;
        transform: translateY(0);
      }

      /* Loading Spinner */
      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: none;
      }

      @keyframes spin {
        to {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }

      /* Backdrop */
      .backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        display: none;
      }

      .backdrop.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <button id="scan-btn">Start Barcode Scan</button>
    <div class="backdrop"></div>

    <div id="scanner-container">
      <div class="loading"></div>
      <video id="barcode-scanner" autoplay playsinline></video>
      <div id="scan-overlay">
        <div id="scan-line"></div>
      </div>
    </div>

    <div id="scanned-data">
      <h2>Scanned Data:</h2>
      <p id="scanned-content"></p>
    </div>

    <script>
      const scanBtn = document.getElementById("scan-btn");
      const scannerContainer = document.getElementById("scanner-container");
      const videoElement = document.getElementById("barcode-scanner");
      const scannedData = document.getElementById("scanned-data");
      const scannedContent = document.getElementById("scanned-content");
      const backdrop = document.querySelector(".backdrop");
      const loading = document.querySelector(".loading");

      let scannerActive = false;
      let currentStream = null;

      scanBtn.addEventListener("click", initScanner);

      async function initScanner() {
        try {
          // Show loading and backdrop
          loading.style.display = "block";
          backdrop.classList.add("active");

          // Get camera access
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
              width: { ideal: 1280 },
              height: { ideal: 720 },
            },
          });

          currentStream = stream;
          videoElement.srcObject = stream;

          // Initialize Quagga after video metadata is loaded
          videoElement.onloadedmetadata = () => {
            videoElement.play();
            initQuagga();
            showScanner();
          };
        } catch (error) {
          console.error("Error accessing camera:", error);
          hideScanner();
          alert("Camera access required for scanning");
        }
      }

      function initQuagga() {
        Quagga.init(
          {
            inputStream: {
              name: "Live",
              type: "LiveStream",
              target: videoElement,
              constraints: {
                width: { min: 640 },
                height: { min: 480 },
                aspectRatio: { ideal: 1.333 },
              },
            },
            decoder: {
              readers: ["code_128_reader", "ean_reader", "upc_reader"],
            },
            locate: true,
          },
          (err) => {
            if (err) {
              console.error("Scanner init error:", err);
              hideScanner();
              return;
            }
            Quagga.start();
            loading.style.display = "none";
          }
        );

        Quagga.onDetected((result) => {
          const code = result.codeResult.code;
          handleScanSuccess(code);
        });
      }

      function handleScanSuccess(code) {
        // Visual feedback
        scannerContainer.style.transform = "translate(-50%, -50%) scale(0.95)";
        setTimeout(() => {
          scannerContainer.style.transform = "translate(-50%, -50%) scale(1)";
        }, 100);

        // Display results
        scannedContent.textContent = code;
        scannedData.classList.add("show");

        // Close scanner
        hideScanner();
        logScan(code);
      }

      function showScanner() {
        scannerContainer.classList.add("active");
        scannerActive = true;
      }

      function hideScanner() {
        scannerContainer.classList.remove("active");
        backdrop.classList.remove("active");
        scannerActive = false;

        // Stop streams and Quagga
        if (currentStream) {
          currentStream.getTracks().forEach((track) => track.stop());
        }
        if (Quagga) {
          Quagga.stop();
        }
      }

      function logScan(code) {
        const logEntry = {
          timestamp: new Date().toISOString(),
          code: code,
        };
        console.log("Scan logged:", logEntry);
        // Add your logging logic here
      }

      // Handle window close
      window.addEventListener("beforeunload", hideScanner);
    </script>
  </body>
</html>
